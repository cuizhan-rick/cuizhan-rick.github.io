<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Unix Linux 使用 | Slow is Smooth and Smooth is Fast</title>
<meta name="keywords" content="C&#43;&#43;" />
<meta name="description" content="==注意：进程中自定义变量和环境变量的概念==
静态库制作 ==使用静态库进行链接编译，只会把用到的函数所在的 .o 文件进行加载编译==
gcc -c *.c ar -r libpmath.a *.o # 可查看静态库中的文件 ar -t libpmath.a 动态库制作 gcc -c -fPIC *.c gcc -shared -o libpmath.so *.o 编译相关 # 指定头文件路径和库路径 gcc main.c -Ip_math -Lp_math -lpmath # 查看预编译输出信息 gcc -E main.c -o main.i -v # 将预处理后的文件编译为汇编文件 gcc -S main.i -o main.s # 将汇编文件编译为目标文件(机器码) gcc -c main.s -o main.o # 链接为可执行文件 gcc main.o # 动态库查找路径 LD_LIBRARY_PATH gdb 调试 # 生成带有调试信息的可执行文件 gcc -c -ggdb # 或 -g # 启动调试 gdb a.">
<meta name="author" content="Rick Cui">
<link rel="canonical" href="https://cuizhan-rick.github.io/posts/299-unix-linux-%E4%BD%BF%E7%94%A8/" />
<meta name="google-site-verification" content="XYZabc" />
<meta name="yandex-verification" content="XYZabc" />
<meta name="msvalidate.01" content="XYZabc" />

<script defer src="https://hm.baidu.com/hm.js?c4f60a311141f59e46a3c3223ff62c0b"></script>
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.a8d96e9fdcfb04de6ce842f2e3dc4f0df9ca7b9e31b230fd17e775ab09b8c508.css" integrity="sha256-qNlun9z7BN5s6ELy49xPDfnKe54xsjD9F&#43;d1qwm4xQg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cuizhan-rick.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://cuizhan-rick.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://cuizhan-rick.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://cuizhan-rick.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://cuizhan-rick.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-123-45', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="Unix Linux 使用" />
<meta property="og:description" content="==注意：进程中自定义变量和环境变量的概念==
静态库制作 ==使用静态库进行链接编译，只会把用到的函数所在的 .o 文件进行加载编译==
gcc -c *.c ar -r libpmath.a *.o # 可查看静态库中的文件 ar -t libpmath.a 动态库制作 gcc -c -fPIC *.c gcc -shared -o libpmath.so *.o 编译相关 # 指定头文件路径和库路径 gcc main.c -Ip_math -Lp_math -lpmath # 查看预编译输出信息 gcc -E main.c -o main.i -v # 将预处理后的文件编译为汇编文件 gcc -S main.i -o main.s # 将汇编文件编译为目标文件(机器码) gcc -c main.s -o main.o # 链接为可执行文件 gcc main.o # 动态库查找路径 LD_LIBRARY_PATH gdb 调试 # 生成带有调试信息的可执行文件 gcc -c -ggdb # 或 -g # 启动调试 gdb a." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cuizhan-rick.github.io/posts/299-unix-linux-%E4%BD%BF%E7%94%A8/" /><meta property="og:image" content="https://cuizhan-rick.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-06-09T21:25:34&#43;08:00" />
<meta property="article:modified_time" content="2025-06-09T21:25:34&#43;08:00" />


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cuizhan-rick.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"/>

<meta name="twitter:title" content="Unix Linux 使用"/>
<meta name="twitter:description" content="==注意：进程中自定义变量和环境变量的概念==
静态库制作 ==使用静态库进行链接编译，只会把用到的函数所在的 .o 文件进行加载编译==
gcc -c *.c ar -r libpmath.a *.o # 可查看静态库中的文件 ar -t libpmath.a 动态库制作 gcc -c -fPIC *.c gcc -shared -o libpmath.so *.o 编译相关 # 指定头文件路径和库路径 gcc main.c -Ip_math -Lp_math -lpmath # 查看预编译输出信息 gcc -E main.c -o main.i -v # 将预处理后的文件编译为汇编文件 gcc -S main.i -o main.s # 将汇编文件编译为目标文件(机器码) gcc -c main.s -o main.o # 链接为可执行文件 gcc main.o # 动态库查找路径 LD_LIBRARY_PATH gdb 调试 # 生成带有调试信息的可执行文件 gcc -c -ggdb # 或 -g # 启动调试 gdb a."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://cuizhan-rick.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Unix Linux 使用",
      "item": "https://cuizhan-rick.github.io/posts/299-unix-linux-%E4%BD%BF%E7%94%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Unix Linux 使用",
  "name": "Unix Linux 使用",
  "description": "==注意：进程中自定义变量和环境变量的概念==\n静态库制作 ==使用静态库进行链接编译，只会把用到的函数所在的 .o 文件进行加载编译==\ngcc -c *.c ar -r libpmath.a *.o # 可查看静态库中的文件 ar -t libpmath.a 动态库制作 gcc -c -fPIC *.c gcc -shared -o libpmath.so *.o 编译相关 # 指定头文件路径和库路径 gcc main.c -Ip_math -Lp_math -lpmath # 查看预编译输出信息 gcc -E main.c -o main.i -v # 将预处理后的文件编译为汇编文件 gcc -S main.i -o main.s # 将汇编文件编译为目标文件(机器码) gcc -c main.s -o main.o # 链接为可执行文件 gcc main.o # 动态库查找路径 LD_LIBRARY_PATH gdb 调试 # 生成带有调试信息的可执行文件 gcc -c -ggdb # 或 -g # 启动调试 gdb a.",
  "keywords": [
    "C++"
  ],
  "articleBody": "==注意：进程中自定义变量和环境变量的概念==\n静态库制作 ==使用静态库进行链接编译，只会把用到的函数所在的 .o 文件进行加载编译==\ngcc -c *.c ar -r libpmath.a *.o # 可查看静态库中的文件 ar -t libpmath.a 动态库制作 gcc -c -fPIC *.c gcc -shared -o libpmath.so *.o 编译相关 # 指定头文件路径和库路径 gcc main.c -Ip_math -Lp_math -lpmath # 查看预编译输出信息 gcc -E main.c -o main.i -v # 将预处理后的文件编译为汇编文件 gcc -S main.i -o main.s # 将汇编文件编译为目标文件(机器码) gcc -c main.s -o main.o # 链接为可执行文件 gcc main.o # 动态库查找路径 LD_LIBRARY_PATH gdb 调试 # 生成带有调试信息的可执行文件 gcc -c -ggdb # 或 -g # 启动调试 gdb a.out # 查看代码列表 l # 设置断点 b 行号 # 运行调试 r # step in 逐行调试 s # 逐过程调试 n # 继续 c # 退出 q 打印程序执行后的返回值 echo $?\nUnix 基础知识  man\n查询手册\n# 查询 man 手册的不同章节 man man # 不指定章节号，默认从命令章节开始查询 man printf man 3 printf man 3 dlopen   ldd\nldd a.out ==查看可执行文件的动态链接库==\n  nm\nnm a.out ==下图为直接编译 .o 文件的结果==\n  file\nfile a.out\n  pstree\n查看系统进程树\n  dl\n动态加载 ==注意与自动加载的区别==\n 如果使用了相关函数，在编译时需要链接 ==dl== 库文件\ngcc -ldl\n # 打开动态库 dlopen() # 关闭，只是动态库的引用计数减一 dlclose() # 查看错误，注意，只能查看最近的一次 ==dlopen== 中出现的错误 dlerror() # 在加载的动态库中查找符号 dlsym() #include #include  typedef int (*fun_t)(int,int); int main(int argc, char* argv[]){ // 加载动态库文件  void* handle = dlopen(argv[1], RTLD_NOW); if(handle == NULL){ printf(\"load failed:%s\\n\", dlerror()); return -1; } printf(\"load success!\\n\"); // 根据函数名查询函数地址  fun_t f = (fun_t)dlsym(handle, \"add\"); if(f == NULL){ printf(\"dlsym error: %s\\n\", dlerror()); return -1; } printf(\"3 + 5 = %d\\n\", f(3, 5)); dlclose(handle); return 0; }   strace\n查看系统调用\nstrace ./a.out\n  getpid\n获取当前进程的 PID\n#include #include  int main(){ printf(\"pid = %d\", getpid()); getchar(); return 0; }   errno 错误号和错误信息\nt_stdio.h 文件\n#ifndef T_STDIO_H #define T_STDIO_H  #include  #define E_MSG(MESSAGE,VAL) do{perror(MESSAGE);return (VAL);}while(0)  #endif #include \"t_stdio.h\"// #include  // #include   int main(int argc, char* argv[]){ FILE* f = fopen(argv[1], \"r\"); #if 0if(f == NULL){ // errno=-1; // 根据 errno 获取错误信息 printf(\"fopen failed...%d\\n\", errno); printf(\"fopen failed...%s\\n\", strerror(errno)); // 直接打印错误信息 perror(\"fopen\"); return -1; } #endif  if(f==NULL) // 对代码简单的宏定义封装  E_MSG(\"fopen\",-1); printf(\"fopen success...\\n\"); fclose(f); return 0; }   内存管理 CPU  控制器\nALU 运算器\n寄存器\n缓存\nMMU 内存管理单元\n == 实模式：CPU 直接操作物理内存 ==\n== 保护模式：通过操作系统管理内存（虚拟地址空间）==\nGDT 表与 LDT 表 == GDT 表所有运行的进程都可见，属于操作系统的段 ==\n== LDT 表每个进程所独有==\nproc 文件 vim /proc/$$/maps\n 5868b6ea0000-5868b6f8f000：地址范围 r-xp：访问权限 00030000：库内偏移地址 08:30：映射文件设备号（主设备号:次设备号） 1448：映射文件 i 节点号 /usr/bin/bash: 库路径   r-xp: 可读可执行的，可以理解为 ==代码段==\nr–p: 可读的的，可理解为 ==只读数据段==\nrw-p: 可读可写的，可理解为 ==可写数据段==\ns/p: 共享/私有\nheap: 堆\nstack: 栈\n 进程映射 段的形成  a.out 汇编   链接过程合并目标文件中的段  栈段和栈帧 文件管理 文件描述符  文件描述符（数组下标）始终是当前最小的未使用的下标\n 文件权限  注意：umask 的影响\n 常用函数  open()\nclose()\nread()\nwrite()\n #include \"t_stdio.h\"#include #include #include int cp_file(int s_fd, int d_fd){ int total = 0; int r, w; char buf[128]; while((r = read(s_fd, buf, 128))  0){ char* tmp = buf; while(r  0){ w = write(d_fd, tmp, r); r = r - w; tmp += w; total += w; } } return total; } int main(int argc, char* argv[]){ char msg[256] = \"\"; //打开源文件，以只读的方式打开  int src_fd = open(argv[1], O_RDONLY); if(src_fd == -1){ sprintf(msg, \"open %s failed\", argv[1]); E_MSG(msg, -1); } //打开目标文件，以写的方式打开  //如果文件不存在，则创建文件，指定文件权限为 0644  //如果文件存在，将文件内容清空  int flags = O_WRONLY | O_CREAT | O_TRUNC; int mod = 0644; int dst_fd = open(argv[2],flags, mod); // 将源文件的内容拷贝到目标文件中  cp_file(src_fd, dst_fd); close(src_fd); close(dst_fd); return 0; } 文件描述符重定向 t_file.h\n#ifndef T_FILE_H #define T_FILE_H  #include #include  #endif #include \"t_stdio.h\"#include \"t_file.h\"#include  int main(int argc, char* argv[]){ // 0 1 2  // std_in std_out std_err  char* msg = \"this is rick from beijing...\\n\"; // 打开要重定向到的文件描述符  int flags = O_WRONLY | O_CREAT | O_TRUNC; int fd = open(argv[1], flags, 0644); if(fd == -1) E_MSG(\"open\", -1); // 备份原来的标准输出文件描述符  int s_fd = dup(1); // 将要重定向到的文件描述符拷贝到标准输出的文件描述符  dup2(fd, 1); close(fd); // 输出到标准输出文件描述符  write(1, msg, strlen(msg)); // 输出到重定向的文件，不会输出到屏幕  // 恢复原来的标准输出  dup2(s_fd, 1); close(s_fd); write(1, msg, strlen(msg)); // 输出到屏幕  return 0; } 内存映射  mmap munmap  #include \"t_stdio.h\"#include #include  int main(void){ // 目标：将物理地址映射到进程的虚拟地址空间  // 如果不映射物理地址，则该虚拟地址空间的指针为野指针  // 野指针是不可使用的  int mapLen = 1024; int port = PROT_READ | PROT_WRITE; int flags = MAP_PRIVATE | MAP_ANONYMOUS; void* p = mmap(NULL, mapLen, port, flags, -1, 0); if(p == MAP_FAILED) E_MSG(\"mmap\", -1); // 对映射的内存进行操作  strcpy(p, \"hi, this is rick...\\n\"); printf(\"%s\", (char*)p); // 解除映射  munmap(p, mapLen); return 0; } ",
  "wordCount" : "632",
  "inLanguage": "en",
  "datePublished": "2025-06-09T21:25:34+08:00",
  "dateModified": "2025-06-09T21:25:34+08:00",
  "author":{
    "@type": "Person",
    "name": "Rick Cui"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cuizhan-rick.github.io/posts/299-unix-linux-%E4%BD%BF%E7%94%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Slow is Smooth and Smooth is Fast",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cuizhan-rick.github.io/favicon.ico"
    }
  }
}
</script>

</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://cuizhan-rick.github.io" accesskey="h" title="Welcome Aboard (Alt + H)">Welcome Aboard</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://cuizhan-rick.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://cuizhan-rick.github.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://cuizhan-rick.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://cuizhan-rick.github.io/series" title="Series">
                    <span>Series</span>
                </a>
            </li>
            <li>
                <a href="https://cuizhan-rick.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://cuizhan-rick.github.io">Home</a>&nbsp;»&nbsp;<a href="https://cuizhan-rick.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Unix Linux 使用
    </h1>
    <div class="post-meta"><span title='2025-06-09 21:25:34 +0800 CST'>June 9, 2025</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Rick Cui

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%9d%99%e6%80%81%e5%ba%93%e5%88%b6%e4%bd%9c" aria-label="静态库制作">静态库制作</a></li>
                <li>
                    <a href="#%e5%8a%a8%e6%80%81%e5%ba%93%e5%88%b6%e4%bd%9c" aria-label="动态库制作">动态库制作</a></li>
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e7%9b%b8%e5%85%b3" aria-label="编译相关">编译相关</a></li>
                <li>
                    <a href="#gdb-%e8%b0%83%e8%af%95" aria-label="gdb 调试">gdb 调试</a></li>
                <li>
                    <a href="#%e6%89%93%e5%8d%b0%e7%a8%8b%e5%ba%8f%e6%89%a7%e8%a1%8c%e5%90%8e%e7%9a%84%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="打印程序执行后的返回值">打印程序执行后的返回值</a></li>
                <li>
                    <a href="#unix-%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" aria-label="Unix 基础知识">Unix 基础知识</a></li>
                <li>
                    <a href="#%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" aria-label="内存管理">内存管理</a><ul>
                        
                <li>
                    <a href="#cpu" aria-label="CPU">CPU</a></li>
                <li>
                    <a href="#gdt-%e8%a1%a8%e4%b8%8e-ldt-%e8%a1%a8" aria-label="GDT 表与 LDT 表">GDT 表与 LDT 表</a></li>
                <li>
                    <a href="#proc-%e6%96%87%e4%bb%b6" aria-label="proc 文件">proc 文件</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e6%98%a0%e5%b0%84" aria-label="进程映射">进程映射</a></li>
                <li>
                    <a href="#%e6%ae%b5%e7%9a%84%e5%bd%a2%e6%88%90" aria-label="段的形成">段的形成</a></li>
                <li>
                    <a href="#%e6%a0%88%e6%ae%b5%e5%92%8c%e6%a0%88%e5%b8%a7" aria-label="栈段和栈帧">栈段和栈帧</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86" aria-label="文件管理">文件管理</a><ul>
                        
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6" aria-label="文件描述符">文件描述符</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e6%9d%83%e9%99%90" aria-label="文件权限">文件权限</a></li>
                <li>
                    <a href="#%e5%b8%b8%e7%94%a8%e5%87%bd%e6%95%b0" aria-label="常用函数">常用函数</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e9%87%8d%e5%ae%9a%e5%90%91" aria-label="文件描述符重定向">文件描述符重定向</a></li>
                <li>
                    <a href="#%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84" aria-label="内存映射">内存映射</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>==注意：进程中自定义变量和环境变量的概念==</p>
<h2 id="静态库制作">静态库制作<a hidden class="anchor" aria-hidden="true" href="#静态库制作">#</a></h2>
<p>==使用静态库进行链接编译，只会把用到的函数所在的 <code>.o</code> 文件进行加载编译==</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -c *.c
ar -r libpmath.a *.o

<span style="color:#75715e"># 可查看静态库中的文件</span>
ar -t libpmath.a 
</code></pre></div><h2 id="动态库制作">动态库制作<a hidden class="anchor" aria-hidden="true" href="#动态库制作">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -c -fPIC *.c
gcc -shared -o libpmath.so *.o
</code></pre></div><h2 id="编译相关">编译相关<a hidden class="anchor" aria-hidden="true" href="#编译相关">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 指定头文件路径和库路径</span>
gcc main.c -Ip_math -Lp_math -lpmath
<span style="color:#75715e"># 查看预编译输出信息</span>
gcc -E main.c -o main.i -v
<span style="color:#75715e"># 将预处理后的文件编译为汇编文件</span>
gcc -S main.i -o main.s
<span style="color:#75715e"># 将汇编文件编译为目标文件(机器码)</span>
gcc -c main.s -o main.o
<span style="color:#75715e"># 链接为可执行文件</span>
gcc main.o
<span style="color:#75715e"># 动态库查找路径</span>
LD_LIBRARY_PATH
</code></pre></div><h2 id="gdb-调试">gdb 调试<a hidden class="anchor" aria-hidden="true" href="#gdb-调试">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 生成带有调试信息的可执行文件</span>
gcc -c -ggdb <span style="color:#75715e"># 或 -g</span>
<span style="color:#75715e"># 启动调试</span>
gdb a.out
<span style="color:#75715e"># 查看代码列表</span>
l
<span style="color:#75715e"># 设置断点</span>
b 行号
<span style="color:#75715e"># 运行调试</span>
r
<span style="color:#75715e"># step in 逐行调试</span>
s
<span style="color:#75715e"># 逐过程调试</span>
n
<span style="color:#75715e"># 继续</span>
c
<span style="color:#75715e"># 退出</span>
q
</code></pre></div><h2 id="打印程序执行后的返回值">打印程序执行后的返回值<a hidden class="anchor" aria-hidden="true" href="#打印程序执行后的返回值">#</a></h2>
<p><code>echo $?</code></p>
<h2 id="unix-基础知识">Unix 基础知识<a hidden class="anchor" aria-hidden="true" href="#unix-基础知识">#</a></h2>
<ol start="0">
<li>
<p>man<br>
查询手册</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 查询 man 手册的不同章节</span>
man man
<span style="color:#75715e"># 不指定章节号，默认从命令章节开始查询</span>
man printf
man <span style="color:#ae81ff">3</span> printf
man <span style="color:#ae81ff">3</span> dlopen
</code></pre></div></li>
<li>
<p>ldd<br>
<code>ldd a.out</code>  ==查看可执行文件的动态链接库==<br>
<img loading="lazy" style="margin: auto;" src=".././img/Unix-ldd.jpg" alt="Unix-ldd"  />
</p>
</li>
<li>
<p>nm<br>
<code>nm a.out</code>  ==下图为直接编译 <code>.o</code> 文件的结果==<br>
<img loading="lazy" style="margin: auto;" src=".././img/Unix-nm.jpg" alt="Unix-nm"  />
</p>
</li>
<li>
<p>file<br>
<code>file a.out</code><br>
<img loading="lazy" style="margin: auto;" src=".././img/Unix-file.jpg" alt="Unix-file"  />
</p>
</li>
<li>
<p>pstree<br>
查看系统进程树<br>
<img loading="lazy" style="margin: auto;" src=".././img/Unix-pstree.jpg" alt="Unix-pstree"  />
</p>
</li>
<li>
<p>dl<br>
动态加载  ==注意与自动加载的区别==</p>
<blockquote>
<p>如果使用了相关函数，在编译时需要链接 ==dl== 库文件<br>
<code>gcc -ldl</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 打开动态库</span>
dlopen<span style="color:#f92672">()</span>
<span style="color:#75715e"># 关闭，只是动态库的引用计数减一</span>
dlclose<span style="color:#f92672">()</span>
<span style="color:#75715e"># 查看错误，注意，只能查看最近的一次 ==dlopen== 中出现的错误</span>
dlerror<span style="color:#f92672">()</span>
<span style="color:#75715e"># 在加载的动态库中查找符号</span>
dlsym<span style="color:#f92672">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>fun_t)(<span style="color:#66d9ef">int</span>,<span style="color:#66d9ef">int</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]){
    <span style="color:#75715e">// 加载动态库文件
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> handle <span style="color:#f92672">=</span> dlopen(argv[<span style="color:#ae81ff">1</span>], RTLD_NOW);
    <span style="color:#66d9ef">if</span>(handle <span style="color:#f92672">==</span> NULL){
        printf(<span style="color:#e6db74">&#34;load failed:%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, dlerror());
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    }
    printf(<span style="color:#e6db74">&#34;load success!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#75715e">// 根据函数名查询函数地址
</span><span style="color:#75715e"></span>    fun_t f <span style="color:#f92672">=</span> (fun_t)dlsym(handle, <span style="color:#e6db74">&#34;add&#34;</span>);
    <span style="color:#66d9ef">if</span>(f <span style="color:#f92672">==</span> NULL){
        printf(<span style="color:#e6db74">&#34;dlsym error: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, dlerror());
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    }

    printf(<span style="color:#e6db74">&#34;3 + 5 = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, f(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>));

    dlclose(handle);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
} 
</code></pre></div></li>
<li>
<p>strace<br>
查看系统调用<br>
<code>strace ./a.out</code><br>
<img loading="lazy" style="margin: auto;" src=".././img/Unix-strace.jpg" alt="Unix-strace"  />
</p>
</li>
<li>
<p>getpid<br>
获取当前进程的 PID</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
    printf(<span style="color:#e6db74">&#34;pid = %d&#34;</span>, getpid());

    getchar();

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div></li>
<li>
<p><code>errno</code> 错误号和错误信息</p>
<p><code>t_stdio.h</code> 文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#ifndef T_STDIO_H
</span><span style="color:#75715e">#define T_STDIO_H
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define E_MSG(MESSAGE,VAL) do{perror(MESSAGE);return (VAL);}while(0)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#endif
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;t_stdio.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// #include &lt;errno.h&gt;
</span><span style="color:#75715e">// #include &lt;string.h&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]){
    FILE<span style="color:#f92672">*</span> f <span style="color:#f92672">=</span> fopen(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;r&#34;</span>);
<span style="color:#75715e">#if 0</span><span style="color:#75715e">
</span><span style="color:#75715e">    if(f == NULL){
</span><span style="color:#75715e">            // errno=-1;
</span><span style="color:#75715e">            // 根据 errno 获取错误信息
</span><span style="color:#75715e">            printf(&#34;fopen failed...%d\n&#34;, errno);
</span><span style="color:#75715e">            printf(&#34;fopen failed...%s\n&#34;, strerror(errno));
</span><span style="color:#75715e">
</span><span style="color:#75715e">            // 直接打印错误信息
</span><span style="color:#75715e">            perror(&#34;fopen&#34;);
</span><span style="color:#75715e">            return -1;
</span><span style="color:#75715e">    }
</span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span>(f<span style="color:#f92672">==</span>NULL)
            <span style="color:#75715e">// 对代码简单的宏定义封装
</span><span style="color:#75715e"></span>            E_MSG(<span style="color:#e6db74">&#34;fopen&#34;</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);

    printf(<span style="color:#e6db74">&#34;fopen success...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    fclose(f);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div></li>
</ol>
<h2 id="内存管理">内存管理<a hidden class="anchor" aria-hidden="true" href="#内存管理">#</a></h2>
<h3 id="cpu">CPU<a hidden class="anchor" aria-hidden="true" href="#cpu">#</a></h3>
<blockquote>
<p>控制器<br>
<code>ALU</code> 运算器<br>
寄存器<br>
缓存<br>
<code>MMU</code> 内存管理单元</p>
</blockquote>
<p>== 实模式：CPU 直接操作物理内存 ==</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86.jpg" alt="Unix-内存管理"  />
</p>
<p>== 保护模式：通过操作系统管理内存（虚拟地址空间）==</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86.jpg" alt="Unix-保护模式内存管理.jpg"  />
</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86.jpg" alt="Unix-操作系统内存管理.jpg"  />
</p>
<h3 id="gdt-表与-ldt-表">GDT 表与 LDT 表<a hidden class="anchor" aria-hidden="true" href="#gdt-表与-ldt-表">#</a></h3>
<p>== <code>GDT</code> 表所有运行的进程都可见，属于操作系统的段 ==<br>
== <code>LDT</code> 表每个进程所独有==</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-GDT-LDT.jpg" alt="Unix-GDT-LDT"  />
</p>
<h3 id="proc-文件">proc 文件<a hidden class="anchor" aria-hidden="true" href="#proc-文件">#</a></h3>
<p><code>vim /proc/$$/maps</code></p>
<ul>
<li><code>5868b6ea0000-5868b6f8f000</code>：地址范围</li>
<li><code>r-xp</code>：访问权限</li>
<li><code>00030000</code>：库内偏移地址</li>
<li><code>08:30</code>：映射文件设备号（主设备号:次设备号）</li>
<li><code>1448</code>：映射文件 i 节点号</li>
<li><code>/usr/bin/bash</code>: 库路径</li>
</ul>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-proc%e6%96%87%e4%bb%b6.jpg" alt="Unix-proc文件"  />
</p>
<blockquote>
<p>r-xp: 可读可执行的，可以理解为 ==代码段==<br>
r&ndash;p: 可读的的，可理解为 ==只读数据段==<br>
rw-p: 可读可写的，可理解为 ==可写数据段==<br>
s/p: 共享/私有<br>
heap: 堆<br>
stack: 栈</p>
</blockquote>
<h3 id="进程映射">进程映射<a hidden class="anchor" aria-hidden="true" href="#进程映射">#</a></h3>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e8%bf%9b%e7%a8%8b%e6%98%a0%e5%b0%84.jpg" alt="Unix-进程映射"  />
</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e8%bf%9b%e7%a8%8b%e6%98%a0%e5%b0%842.jpg" alt="Unix-进程映射2.jpg"  />
</p>
<h3 id="段的形成">段的形成<a hidden class="anchor" aria-hidden="true" href="#段的形成">#</a></h3>
<ul>
<li><strong><code>a.out</code> 汇编</strong></li>
</ul>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%ae%b5%e7%9a%84%e6%b1%87%e7%bc%96%e6%98%be%e7%a4%ba.jpg" alt="Unix-段的汇编显示.jpg"  />
</p>
<ul>
<li><strong>链接过程合并目标文件中的段</strong></li>
</ul>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%ae%b5%e7%9a%84%e5%bd%a2%e6%88%90.jpg" alt="Unix-段的形成"  />
</p>
<h3 id="栈段和栈帧">栈段和栈帧<a hidden class="anchor" aria-hidden="true" href="#栈段和栈帧">#</a></h3>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%a0%88%e6%ae%b5%e5%92%8c%e6%a0%88%e5%b8%a7.jpg" alt="Unix-栈段和栈帧"  />
</p>
<h3 id="文件管理">文件管理<a hidden class="anchor" aria-hidden="true" href="#文件管理">#</a></h3>
<h4 id="文件描述符">文件描述符<a hidden class="anchor" aria-hidden="true" href="#文件描述符">#</a></h4>
<blockquote>
<p>文件描述符（数组下标）始终是当前最小的未使用的下标</p>
</blockquote>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6.jpg" alt="Unix-文件描述符"  />
</p>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a62.jpg" alt="Unix-文件描述符2"  />
</p>
<h4 id="文件权限">文件权限<a hidden class="anchor" aria-hidden="true" href="#文件权限">#</a></h4>
<blockquote>
<p>注意：umask 的影响</p>
</blockquote>
<h4 id="常用函数">常用函数<a hidden class="anchor" aria-hidden="true" href="#常用函数">#</a></h4>
<blockquote>
<p>open()<br>
close()<br>
read()<br>
write()</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;t_stdio.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">cp_file</span>(<span style="color:#66d9ef">int</span> s_fd, <span style="color:#66d9ef">int</span> d_fd){
    <span style="color:#66d9ef">int</span> total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> r, w;
    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">128</span>];
    <span style="color:#66d9ef">while</span>((r <span style="color:#f92672">=</span> read(s_fd, buf, <span style="color:#ae81ff">128</span>)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
        <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> tmp <span style="color:#f92672">=</span> buf;
        <span style="color:#66d9ef">while</span>(r <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
            w <span style="color:#f92672">=</span> write(d_fd, tmp, r);
            r <span style="color:#f92672">=</span> r <span style="color:#f92672">-</span> w;  
            tmp <span style="color:#f92672">+=</span> w;
            total <span style="color:#f92672">+=</span> w;
        }
    }
    <span style="color:#66d9ef">return</span> total;
}
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]){
    <span style="color:#66d9ef">char</span> msg[<span style="color:#ae81ff">256</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
    <span style="color:#75715e">//打开源文件，以只读的方式打开
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> src_fd <span style="color:#f92672">=</span> open(argv[<span style="color:#ae81ff">1</span>], O_RDONLY);
    <span style="color:#66d9ef">if</span>(src_fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>){
        sprintf(msg, <span style="color:#e6db74">&#34;open %s failed&#34;</span>, argv[<span style="color:#ae81ff">1</span>]);
        E_MSG(msg, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
    }
    <span style="color:#75715e">//打开目标文件，以写的方式打开
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//如果文件不存在，则创建文件，指定文件权限为 0644
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//如果文件存在，将文件内容清空
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> O_WRONLY <span style="color:#f92672">|</span> O_CREAT <span style="color:#f92672">|</span> O_TRUNC;
    <span style="color:#66d9ef">int</span> mod <span style="color:#f92672">=</span> <span style="color:#ae81ff">0644</span>;
    <span style="color:#66d9ef">int</span> dst_fd <span style="color:#f92672">=</span> open(argv[<span style="color:#ae81ff">2</span>],flags, mod);

    <span style="color:#75715e">// 将源文件的内容拷贝到目标文件中
</span><span style="color:#75715e"></span>    cp_file(src_fd, dst_fd);
    close(src_fd);
    close(dst_fd);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h4 id="文件描述符重定向">文件描述符重定向<a hidden class="anchor" aria-hidden="true" href="#文件描述符重定向">#</a></h4>
<p><code>t_file.h</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#ifndef T_FILE_H
</span><span style="color:#75715e">#define T_FILE_H
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#endif
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;t_stdio.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;t_file.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]){
    <span style="color:#75715e">// 0 1 2
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// std_in std_out std_err
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;this is rick from beijing...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;

    <span style="color:#75715e">// 打开要重定向到的文件描述符
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> O_WRONLY <span style="color:#f92672">|</span> O_CREAT <span style="color:#f92672">|</span> O_TRUNC;
    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(argv[<span style="color:#ae81ff">1</span>], flags, <span style="color:#ae81ff">0644</span>);
    <span style="color:#66d9ef">if</span>(fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        E_MSG(<span style="color:#e6db74">&#34;open&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
    <span style="color:#75715e">// 备份原来的标准输出文件描述符
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> s_fd <span style="color:#f92672">=</span> dup(<span style="color:#ae81ff">1</span>);
    <span style="color:#75715e">// 将要重定向到的文件描述符拷贝到标准输出的文件描述符
</span><span style="color:#75715e"></span>    dup2(fd, <span style="color:#ae81ff">1</span>);
    close(fd);
    <span style="color:#75715e">// 输出到标准输出文件描述符
</span><span style="color:#75715e"></span>    write(<span style="color:#ae81ff">1</span>, msg, strlen(msg));  <span style="color:#75715e">// 输出到重定向的文件，不会输出到屏幕
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 恢复原来的标准输出
</span><span style="color:#75715e"></span>    dup2(s_fd, <span style="color:#ae81ff">1</span>);
    close(s_fd);
    write(<span style="color:#ae81ff">1</span>, msg, strlen(msg));  <span style="color:#75715e">// 输出到屏幕
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h4 id="内存映射">内存映射<a hidden class="anchor" aria-hidden="true" href="#内存映射">#</a></h4>
<ul>
<li><code>mmap</code></li>
<li><code>munmap</code></li>
</ul>
<p><img loading="lazy" style="margin: auto;" src=".././img/Unix-mmap-%e6%96%87%e4%bb%b6%e6%98%a0%e5%b0%84.jpg" alt="Unix-mmap-文件映射"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;t_stdio.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/mman.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>){
        <span style="color:#75715e">// 目标：将物理地址映射到进程的虚拟地址空间
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 如果不映射物理地址，则该虚拟地址空间的指针为野指针
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 野指针是不可使用的
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> mapLen <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
        <span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> PROT_READ <span style="color:#f92672">|</span> PROT_WRITE;
        <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> MAP_PRIVATE <span style="color:#f92672">|</span> MAP_ANONYMOUS;
        <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> mmap(NULL, mapLen, port, flags, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
        <span style="color:#66d9ef">if</span>(p <span style="color:#f92672">==</span> MAP_FAILED)
                E_MSG(<span style="color:#e6db74">&#34;mmap&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);

        <span style="color:#75715e">// 对映射的内存进行操作
</span><span style="color:#75715e"></span>        strcpy(p, <span style="color:#e6db74">&#34;hi, this is rick...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        printf(<span style="color:#e6db74">&#34;%s&#34;</span>, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)p);

        <span style="color:#75715e">// 解除映射
</span><span style="color:#75715e"></span>        munmap(p, mapLen);

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://cuizhan-rick.github.io/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://cuizhan-rick.github.io/posts/298-c&#43;&#43;-%E4%B8%A4%E4%B8%AA%E7%BA%BF%E7%A8%8B%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B0%E8%BE%93%E5%87%BA/">
    <span class="title">Next Page »</span>
    <br>
    <span>C&#43;&#43;——两个线程交替打印输出</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>"Take time for all things: great haste makes great waste." – Benjamin Franklin</span><br/>
    <span>&copy; 2025 <a href="https://cuizhan-rick.github.io">Slow is Smooth and Smooth is Fast</a></span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
